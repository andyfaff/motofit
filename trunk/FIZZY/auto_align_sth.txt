//automated batch file angle aligner//assumes that the sample is roughly at the right height.//you can't just you through this script in a cycle.//this is because there is deliberately no setting of offsets// To set the sth and sz offsets after the script type://sics("setpos sth 0.5" )), if you're using that angle of incidencesetdatafolder root:variable/g angleofincidence = 0.5omega_2theta(root:angleofincidence, root:angleofincidence*2)vslits(5,0.3,0.3,5)run("st4vt",0)//dz drive will depend on how thick your sample is.//for solid-liquid this might be a lotrel("sz",-2.5)run("sth",0)fpx("dummy_motor",0,1,mode="time",preset=10,savetype=1,automatic=2)processNexusfile("V:data:current:","C:temp:","scratch",1,1,18,isDirect=1,scanpointrange="0",expected_peak=cmplx(ROUGH_BEAM_POSITION - getpos("dy")*tan(2*Pi*root:angleofincidence/180)/Y_PIXEL_SPACING, 100))//we SHOULD have the db pixel where the direct beam hits.variable/g db_pixel =  numberbykey("centre", note(root:packages:platypus:data:Reducer:scratch:M_topandtail))print "DB_PIXEL is: ", db_pixel//now do a quick acquisition to see where the reflected beam is.rel("sz",2.5)omega_2theta(root:angleofincidence, root:angleofincidence*2)vslits(5,0.3,0.3,5)drive("ss4u", 15)drive("ss4d",-2.5)fpx("dummy_motor",0,1,mode="time",preset=20,savetype=1,automatic=2)processNexusfile("V:data:current","C:temp:","scratch",1,1,18,isDirect=0,scanpointrange="0",expected_peak=cmplx(ROUGH_BEAM_POSITION,100))variable/g ref_pixel =  numberbykey("centre", note(root:packages:platypus:data:Reducer:scratch:M_topandtail))//work out the actual angle of incidencevariable/g omegaroot:omega = wott(root:ref_pixel, root:db_pixel, getpos("dy"))print root:ref_pixel, root:db_pixelprint "to get to request angle of incidence drive to: ", root:angleofincidence - (root:omega-root:angleofincidence)drive("sth", root:angleofincidence - (root:omega-root:angleofincidence))//now do an "sz" scanvslits(5,0.3,0.3,5)fpx("sz", 1.5,15,mode="time", preset = 1, savetype=1,automatic=1)killvariables/z dy, omega, db_pixel, ref_pixel, angleofincidenceprint "******APPLY OFFSETS OF sz:", getpos("sz") , " AND sth: ", getpos("sth")-0.5