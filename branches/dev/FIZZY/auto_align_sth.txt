//automated batch file angle aligner
//assumes that the sample is roughly at the right height.
//you can't just you through this script in a cycle.
//this is because there is deliberately no setting of offsets
// To set the sth and sz offsets after the script type:
//sics("setpos sth 0.5" )), if you're using that angle of incidence

setdatafolder root:
variable/g angleofincidence = 0.5

omega_2theta(root:angleofincidence, root:angleofincidence*2)
vslits(5,0.4,0.4,2)
run("st4vt",0)
//dz drive will depend on how thick your sample is.
//for solid-liquid this might be a lot
rel("sz",-5)
run("sth",0)
fpx("_none_",0,1,presettype="TIME",preset=10,saveOrNot=1,auto=2)
loadNexusfile("\\Filer\experiments\platypus\commissioning\","scratch.nx.hdf")
processNexusfile("scratch",1,1,18,isDirect=1,scanpoint=0,expected_width = 100, expected_centre=ROUGH_BEAM_POSITION - getpos("dy")*tan(2*Pi*root:angleofincidence/180)/Y_PIXEL_SPACING)
//we SHOULD have the db pixel where the direct beam hits.
variable/g db_pixel =  numberbykey("centre", note(root:packages:platypus:data:Reducer:scratch:M_topandtail))
print "DB_PIXEL is: ", db_pixel

//now do a quick acquisition to see where the reflected beam is.
rel("sz",5)
omega_2theta(root:angleofincidence, root:angleofincidence*2)
vslits(5,0.4,0.4,3)
drive("ss4u", 25)
drive("ss4d",-2.5)
fpx("_none_",0,1,presettype="TIME",preset=20,saveOrNot=1,auto=2)
loadNexusfile("\\Filer\experiments\platypus\commissioning\","scratch.nx.hdf")
processNexusfile("scratch",1,1,18,isDirect=0,scanpoint=0,expected_centre=ROUGH_BEAM_POSITION, expected_width = 100)
variable/g ref_pixel =  numberbykey("centre", note(root:packages:platypus:data:Reducer:scratch:M_topandtail))

//work out the actual angle of incidence
variable/g omega
root:omega = wott(root:ref_pixel, root:db_pixel, getpos("dy"))
print "to get to request angle of incidence drive to: ", root:angleofincidence - (root:omega-root:angleofincidence)
drive("sth", root:angleofincidence - (root:omega-root:angleofincidence))

//now do an "sz" scan
vslits(5,0.4,0.4,1)
fpx("sz", 1.4,40,presettype="TIME", preset = 2, saveOrNot=1,auto=1)

killvariables/z dy, omega, db_pixel, ref_pixel, angleofincidence